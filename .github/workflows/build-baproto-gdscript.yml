name: "ðŸ“¦ Build: 'baproto-gdscript'"

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      # Required
      archive-name:
        required: true
        type: string
      target:
        required: true
        type: string
      os:
        type: string
        required: true

      # Optional
      timeout:
        required: false
        type: number
        default: 4
      use_cross:
        required: false
        type: boolean
        default: false

  # Triggered from the UI; see
  # https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#workflow_dispatch.
  workflow_dispatch:
    inputs:
      # Required
      archive-name:
        required: true
        type: string
      target:
        required: true
        type: choice
        options:
          - aarch64-apple-darwin
          - x86_64-apple-darwin
          - aarch64-unknown-linux-gnu
          - x86_64-unknown-linux-gnu
          - x86_64-pc-windows-gnu
          - x86_64-pc-windows-msvc
      os:
        required: true
        type: choice
        options:
          - "ubuntu-latest"
          - "macos-latest"
          - "windows-latest"

      # Optional
      timeout:
        required: false
        type: number
        default: 4
      use_cross:
        required: false
        type: boolean
        default: false

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ${{ inputs.os }}
    timeout-minutes: ${{ fromJSON(inputs.timeout) }}

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: "coffeebeats/build-a-proto/.github/actions/parse-rust-version@e194a2077f0617bd05004cc81ea5098ee2cb1cf7"
        id: rust

      - uses: "coffeebeats/build-a-proto/.github/actions/setup-rust@e194a2077f0617bd05004cc81ea5098ee2cb1cf7"
        with:
          profile: minimal
          targets: ${{ inputs.target }}
          version: ${{ steps.rust.outputs.version }}

      # Set minimum supported version to '11.1', which guarantees support for
      # M1 macs (see https://developer.apple.com/support/xcode).
      - name: Set OSX environment variables
        if: endsWith(inputs.target, 'apple-darwin')
        run: |
          echo "SDKROOT=$(xcrun -sdk macosx11.1 --show-sdk-path)" >> $GITHUB_ENV
          echo "MACOSX_DEPLOYMENT_TARGET=11.1" >> $GITHUB_ENV

      - uses: "coffeebeats/build-a-proto/.github/actions/cargo-build@e194a2077f0617bd05004cc81ea5098ee2cb1cf7"
        with:
          platform: ${{ inputs.target }}
          profile: release
          targets: bins
          use_cross: ${{ inputs.use_cross }}
          target-dir: .target

      - name: Archive executable (Default)
        if: runner.os != 'Windows'
        run: |
          tar \
          -C ".target/${{ inputs.target }}/release" \
          -czf ${{ inputs.archive-name }} \
          "baproto-gdscript"

      - name: Archive executable (Windows)
        if: runner.os == 'Windows'
        run: |
          cat <<- EOM | python3 -c "$(</dev/stdin)"
          from zipfile import ZipFile
          with ZipFile("${{ inputs.archive-name }}", mode="w") as a:
            a.write(".target/${{ inputs.target }}/release/baproto-gdscript.exe", arcname="baproto-gdscript.exe")
          EOM

      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: ${{ inputs.target }}
          path: ${{ inputs.archive-name }}
          if-no-files-found: error
