name: "ðŸ”Ž Check: Godot project"

on:
  workflow_call:
    inputs:
      has_source_change:
        description: "Whether any GDScript source code changes need to be checked."
        required: true
        type: boolean

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
  format-and-lint:
    if: |
      inputs.has_source_change &&
      github.actor != 'dependabot[bot]'

    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          # Checkout the "head_ref" (i.e. PR branch HEAD) in case a commit is
          # later needed. See https://github.com/stefanzweifel/git-auto-commit-action
          # for more details.
          ref: ${{ github.head_ref }}
          # Use a PAT so that GitHub Actions will trigger on the resulting commit.
          token: ${{ secrets.GHA_TOKEN }}

      - uses: coffeebeats/godot-infra/check-godot-project@v4
        with:
          ignore-lint-errors: false
          line-length-max: 88

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          submodules: true

      - uses: coffeebeats/godot-infra/.github/actions/parse-godot-version@v4
        id: version
        with:
          gdenv-pin-path: .godot-version

      - uses: coffeebeats/godot-infra/.github/actions/setup-godot@v4
        with:
          version: ${{ steps.version.outputs.semantic }}

      - name: Initialize project imports
        run: godot --verbose --headless --quit --import

      - name: Test source code
        run: >-
          godot
          --verbose
          --headless
          -s addons/gut/gut_cmdln.gd
          -gdir=res://
          -ginclude_subdirs
          -gprefix=
          -gsuffix=_test.gd
          -gexit
