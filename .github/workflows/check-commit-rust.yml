name: "ðŸ¤– Check: 'baproto'"

on:
  workflow_call:
    inputs:
      has_source_change:
        description: "Whether any Rust source code changes need to be checked."
        required: true
        type: boolean

permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:
  config:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    outputs:
      rust_version: ${{ steps.rust.outputs.version }}

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: "coffeebeats/build-a-proto/.github/actions/parse-rust-version@7fd0e3619e89ed8a495037a85c384e8954b98b81"
        id: rust

  build:
    needs: ["config"]

    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: "coffeebeats/build-a-proto/.github/actions/setup-rust@7fd0e3619e89ed8a495037a85c384e8954b98b81"
        with:
          version: ${{ needs.config.outputs.rust_version }}
          profile: minimal

      - uses: "coffeebeats/build-a-proto/.github/actions/cargo-build@7fd0e3619e89ed8a495037a85c384e8954b98b81"
        with:
          profile: release
          target-dir: .target

  format:
    needs: ["config"]
    if: |
      inputs.has_source_change &&
      github.actor != 'dependabot[bot]'

    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          # Checkout the "head_ref" (i.e. PR branch HEAD) in case a commit is
          # later needed. See https://github.com/stefanzweifel/git-auto-commit-action
          # for more details.
          ref: ${{ github.head_ref }}
          # Use a PAT so that GitHub Actions will trigger on the resulting commit.
          token: ${{ secrets.GHA_TOKEN }}

      - uses: "coffeebeats/build-a-proto/.github/actions/setup-rust@7fd0e3619e89ed8a495037a85c384e8954b98b81"
        id: setup-rust
        with:
          components: rustfmt
          profile: minimal
          version: ${{ needs.config.outputs.rust_version }}

      - name: Check Rust source formatting
        id: format
        continue-on-error: true
        run: cargo fmt --check

      - name: Fix formatting of source code
        if: steps.format.outcome == 'failure'
        run: |
          cargo fmt

          # See https://github.com/orgs/community/discussions/26560#discussioncomment-3531273
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          git add --all '*.rs'
          git commit -m "chore: fix formatting (on behalf of '${{ github.triggering_actor }}')"

          git push

      - name: Terminate CI run early
        if: steps.format.outcome == 'failure'
        run: exit 1

  lint:
    needs: ["build", "config", "format"]
    if: inputs.has_source_change

    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: "coffeebeats/build-a-proto/.github/actions/setup-rust@7fd0e3619e89ed8a495037a85c384e8954b98b81"
        with:
          components: clippy
          profile: minimal
          version: ${{ needs.config.outputs.rust_version }}

      # NOTE: 'cargo clippy' does not seem to use the 'cargo build' cache; as
      # such, skip loading the build cache.

      - name: Lint 'rust' source
        run: |
          cargo clippy \
            --all-features \
            --all-targets \
            --no-deps \
            --target=x86_64-unknown-linux-gnu \
            -- \
              --deny=warnings

  test:
    needs: ["build", "config"]

    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: "coffeebeats/build-a-proto/.github/actions/setup-rust@7fd0e3619e89ed8a495037a85c384e8954b98b81"
        with:
          profile: minimal
          version: ${{ needs.config.outputs.rust_version }}

      - uses: "coffeebeats/build-a-proto/.github/actions/cargo-build@7fd0e3619e89ed8a495037a85c384e8954b98b81"
        with:
          profile: release
          target-dir: .target

      - name: Test source code
        run: |
          cargo test \
            --all-features \
            --all-targets \
            --frozen \
            --profile=release \
            --target=x86_64-unknown-linux-gnu
