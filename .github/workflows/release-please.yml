name: "ðŸš€ Release: Plugin version"

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  release-please:
    if: github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: 4

    outputs:
      release-created: ${{ steps.release.outputs.releases_created }}
      release-tag: ${{ steps.release.outputs.tag_name }}

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38
        id: release
        with:
          config-file: .release-please/config.json
          manifest-file: .release-please/manifest.json

          # NOTE: If you want 'release-please' PRs to trigger CI/CD workflows,
          # then a PAT is required. This PAT must have 'contents:write' and
          # 'pull_requests:write'.
          token: ${{ secrets.RELEASE_PLEASE_TOKEN || github.token }}

          # NOTE: To handle releases on specific branches (e.g. a '1.X' release branch),
          # simply change the "branches" filter in the workflow's on-"push" trigger.
          target-branch: ${{ github.ref_name }}

      - name: Log release-please action output
        shell: bash
        env:
          # See https://github.com/actions/runner/issues/1656#issuecomment-1030077729.
          RELEASE_INFO: ${{ toJson(steps.release.outputs) }}
        run: echo $RELEASE_INFO

  build:
    needs: ["release-please"]
    if: needs.release-please.outputs.release-created == 'true'

    uses: "./.github/workflows/build-baproto-gdscript.yml"
    with:
      archive-name: ${{ matrix.archive }}
      target: ${{ matrix.target }}
      os: ${{ matrix.os }}
      use_cross: ${{ matrix.use_cross == true }}
      timeout: 15

    strategy:
      fail-fast: true
      matrix:
        include:
          # Apple
          - archive: baproto-gdscript-${{ needs.release-please.outputs.release-tag }}-macos-arm64.tar.gz
            target: aarch64-apple-darwin
            os: macos-latest
          - archive: baproto-gdscript-${{ needs.release-please.outputs.release-tag }}-macos-x86_64.tar.gz
            target: x86_64-apple-darwin
            os: macos-latest

          # Linux
          - archive: baproto-gdscript-${{ needs.release-please.outputs.release-tag }}-linux-x86_64.tar.gz
            target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            use_cross: true
          - archive: baproto-gdscript-${{ needs.release-please.outputs.release-tag }}-linux-arm64.tar.gz
            target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            use_cross: true

          # Windows
          - archive: baproto-gdscript-${{ needs.release-please.outputs.release-tag }}-windows-x86_64.zip
            target: x86_64-pc-windows-msvc
            os: windows-latest

  release-branch:
    needs: ["release-please"]
    if: |
      !failure() && !cancelled() && (
        needs.release-please.outputs.release-created == 'true' ||
        github.event_name == 'workflow_dispatch'
      )

    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          submodules: true

      # ------------------------- Download: Binaries ------------------------- #

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          path: ./bin
          merge-multiple: true

      - name: Extract artifacts
        run: |
          extract() {
            TARGET="$1"
            EXT="$2"

            mkdir bin/$TARGET

            FILE="bin/baproto-gdscript-${{ needs.release-please.outputs.release-tag }}-${TARGET}.${EXT}"
            if [[ "$EXT" == 'zip' ]]; then
              unzip $FILE -d bin/$TARGET
            else
              tar -C bin/$TARGET -xzf $FILE
            fi

          }

          # Extract all compiled binaries
          extract macos-arm64 tar.gz
          extract macos-x86_64 tar.gz
          extract linux-x86_64 tar.gz
          extract linux-arm64 tar.gz
          extract windows-x86_64 zip

          # Delete compressed artifacts
          rm -rf ./bin/*.tar.gz ./bin/*.zip

      # --------------------------- Publish: Plugin -------------------------- #

      - uses: coffeebeats/godot-infra/.github/actions/parse-godot-version@v3
        id: version
        with:
          gdenv-pin-path: .godot-version

      - name: Determine plugin name
        id: subfolder
        shell: bash
        run: echo name="$(echo ${{ github.repository }} | sed -E 's/^${{ github.repository_owner }}\/godot-plugin-//')" >> $GITHUB_OUTPUT

      - uses: coffeebeats/godot-infra/package-addon@v3
        with:
          subfolder: ${{ steps.subfolder.outputs.name }}
          target-branch: "godot-v${{ steps.version.outputs.major-minor }}"
          godot-editor-version: "v${{ steps.version.outputs.semantic }}"
          file-excludes: |
            **/*_test.gd
